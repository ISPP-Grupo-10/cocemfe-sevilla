{% extends 'base.html' %}
{% load static %}

{% block contenido %}
{% if messages %}
    <div class="container mt-3">
        <div class="row justify-content-center">
            <div class="col-md-6">
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                        <small>{{ message }}</small><br>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <script>
        setTimeout(function() {
            var errorMessage = document.querySelector('.alert');
            errorMessage.style.display = 'none';
        }, 20000);
    </script>
{% endif %}



<link rel="stylesheet" type="text/css" href="{% static 'css/view_pdf.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/chat.css' %}">
<h2 class="text-center">Detalles de documento</h2>
<div class='doc-container'>
    <div class="doc-info">
        <p><strong>Documento:</strong> {{ pdf.name }}</p>
        <p><strong>Plazo:</strong> {{ pdf.start_date }} - {{ pdf.end_date }}</p>
        <p><strong>Ubicación:</strong> {{ pdf.ubication }}</p>
        <p class="estado-{{ pdf.status|lower }}">{{ pdf.status }}</p>
    </div>
    <div class="row">
        {% if pdf.pdf_file %}
        
        <div class="doc-visualizer">
            <iframe name="pdfViewer" id="pdfViewer" src="{{ pdf.pdf_file.url }}"></iframe>
        </div> 

        {% else %}
        <div class="doc-visualizer">
            <p>No hay archivo adjunto.</p>
        </div>
        {% endif %}
        <div class="doc-comments">
            <!-- Aquí puedes colocar el contenido de los comentarios -->
            <h3>Comentarios</h3>
            <div class="comments-container">
                {% for suggestion in page_obj %}
                    <div class="comment-box" onclick="goToSuggestionPage(parseInt('{{ suggestion.page }}'), '{{ pdf.pdf_file.url }}', '{{ suggestion.section }}')">
                        <div class="comment-header">
                            <span>{{ suggestion.professional }}</span>
                            <span>{{ suggestion.date }}</span>
                        </div>
                        <div class="comment-content">
                            <p style="font-size: 19px;">{{ suggestion.main }}</p>
                            <p style="color: #4b4a4a;">{{ suggestion.justification }}</p>
                            <!-- Agrega más contenido si es necesario -->
                        </div>
                    </div>
                {% empty %}
                    <b>No hay comentarios</b>
                {% endfor %}
            </div>
            <div class="pagination">
                <span class="step-links">
                    {% if page_obj.has_previous %}
                        <b><a style="color: black; text-decoration: none;" href="?page=1">&laquo; Primera</a></b>
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.previous_page_number }}">Anterior</a></b>
                    {% endif %}
        
                    <span class="current">
                        <br>
                        <b>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.</b>
                    </span>
        
                    {% if page_obj.has_next %}
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.next_page_number }}">Siguiente</a></b>
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a></b>
                    {% endif %}
                </span>
            </div>
        </div>
        

        {% if pdf.status == 'Aportaciones' %}
        <div class="comment-form-container">
            <!-- Formulario para enviar comentarios -->
            <form method="post" action="{% url 'create_suggestion' document_id=pdf.pk %}">
                {% csrf_token %}
                <div class="comment-field">
                    <label for="main">Título del comentario:</label>
                    <input type="text" id="main" name="main" placeholder="Título del comentario" required>
                </div>
                <div class="comment-field">
                    <label for="relevance">Relevancia:</label>
                    <select id="relevance" name="relevance" required>
                        <option value="urgente">Muy importante</option>
                        <option value="importante">Importante</option>
                        <option value="poco">Poco importante</option>
                    </select>
                </div>
                <div class="comment-field">
                    <label for="justification">Cuerpo del comentario:</label>
                    <textarea id="justification" name="justification" placeholder="Cuerpo del comentario" required></textarea>
                </div>

                <div class="comment-field">
                    <label for="section">Sección:</label>
                    <textarea id="section" name="section" placeholder="Sección" required></textarea>
                </div>
            
                <div class="comment-field">
                    <label for="page">Pagina:</label><br>
                    <input type="number" id="page" name="page" required>
                </div>

                <button type="submit">Enviar comentario</button>
            </form>
        </div>
        {% endif %}
        
    </div>
    {% if request.user.is_staff or request.user in pdf.professionals.all %}
    <a href="{% url 'view_pdf_chat' pk=pdf.pk %}">
        <button type="button" class="btn btn-secondary" href="{% url 'view_pdf_chat' pk=pdf.pk %}" >
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125m.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2"/>
            </svg>
        </button>
    </a>
    {% endif %}

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script>
  // Especificar la ruta del script del trabajador
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
</script>

<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

<script>
    function goToSuggestionPage(pageNumber, pdfUrl, section) {
        // Cargar el PDF usando PDF.js
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdfDoc_) {
            var pdfDoc = pdfDoc_;
            var numPages = pdfDoc.numPages;
            var newObject = document.createElement('iframe');
            
            // Función para subrayar el texto en una página
            console.log(pdfDoc.getPage(pageNumber));
            function highlightText(pageNumber) {
                pdfDoc.getPage(pageNumber).then(function(page) {
                    // Obtener dimensiones del iframe
                    var iframe = document.getElementById('pdfViewer');
                    var iframeRect = iframe.getBoundingClientRect();

                    // Obtener contenido de la página
                    return page.getTextContent().then(function(textContent) {
                        // Recorrer los items del contenido de texto
                        textContent.items.forEach(function(textItem) {
                            // Obtener el texto del item
                            var text = textItem.str;
                            // Si el texto coincide con la sección, resaltarlo
                            if (text.includes(section)) {
                                // Resaltar el texto
                                var div = document.createElement('div');
                                div.style.position = 'absolute';

                                // Coordenadas relativas al iframe
                                var left = textItem.transform[4] - iframeRect.left;
                                var top = textItem.transform[5] - textItem.height - iframeRect.top;

                                div.style.left = left + 'px';
                                div.style.top = top + 'px';
                                div.style.width = textItem.width + 'px';
                                div.style.height = textItem.height + 'px';
                                div.style.backgroundColor = 'yellow'; // Cambiar el color del resaltado según necesites
                                div.style.opacity = '0.5'; // Ajustar la opacidad según sea necesario
                                document.body.appendChild(div);
                            }
                        });
                    });
                });
            }
            
            // Clonar los atributos del objeto actual
            newObject.setAttribute('src', pdfUrl + '#page=' + pageNumber);
            newObject.setAttribute('id', 'pdfViewer');
            newObject.setAttribute('width', '600');
            newObject.setAttribute('height', '400');

            // Reemplazar el objeto actual con el nuevo objeto
            var currentObject = document.getElementById('pdfViewer');
            currentObject.parentNode.replaceChild(newObject, currentObject);
            
            // Subrayar el texto en la página especificada
            highlightText(pageNumber);
        });
    }
</script>



{% endblock %}


