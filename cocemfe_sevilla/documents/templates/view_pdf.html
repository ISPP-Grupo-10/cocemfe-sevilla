{% extends 'base.html' %}
{% load static %}

{% block contenido %}
{% if messages %}
    <div class="container mt-3">
        <div class="row justify-content-center">
            <div class="col-md-6">
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                        <small>{{ message }}</small><br>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <script>
        setTimeout(function() {
            var errorMessage = document.querySelector('.alert');
            errorMessage.style.display = 'none';
        }, 20000);
    </script>
{% endif %}


<link rel="stylesheet" type="text/css" href="{% static 'css/view_pdf.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/chat.css' %}">

<h2 class="text-center">Detalles de documento</h2>
<div class='doc-container'>
    {% if request.user.is_staff %}
    <!-- Verifica si el usuario es un admin -->
    <a href="{% url 'update_pdf' pk=pdf.pk %}">
        <button type="button" class="btn btn-primary">Editar Documento</button>
    </a>
    {% endif %}
    <div class="doc-info">
        <p><strong>Documento:</strong> {{ pdf.name }}</p>
        <p><strong>Plazo:</strong> {{ pdf.suggestion_start_date }} - {{ pdf.suggestion_end_date }}</p>
        <p><strong>Ubicación:</strong> {{ pdf.ubication }}</p>
        <p class="estado-{{ pdf.status|lower }}">{{ pdf.status }}</p>
    </div>    
    <div class="row">
        {% if pdf.pdf_file %}
        
        <div class="doc-visualizer">
            
            <iframe id="pdfViewer" src="{% static 'pdfjs/web/viewer.html' %}?file={{ pdf.pdf_file.url | urlencode }}" width="100%" height="600"></iframe>
            <button onclick="toggleFullScreen()" type="submit">Ver en pantalla completa</button>
            <button id="verSeleccionButton" style="display: none;" onclick="verSeleccion()" type="submit">Ver Selección</button>
            <button id="limpiarSeleccionButton" style="display: none;" onclick="limpiarSeleccion()" type="submit">Limpiar Selección</button>

        </div>
        {% else %}
        <div class="doc-visualizer">
            <p>No hay archivo adjunto.</p>
        </div>
        {% endif %}
        <div class="doc-comments">
            <!-- Aquí puedes colocar el contenido de los comentarios -->
            <h3>Comentarios</h3>
            <div class="comments-container">
                {% for suggestion in page_obj %}
                    {% if pdf.status == 'Votaciones' %}
                        {% with suggestion_id=suggestion.id %}
                            <div class="comment-box">
                                <a href="{% url 'view_suggestion' suggestion.id %}">
                                    <div class="comment-header">
                                        <span>{{ suggestion.professional }}</span>
                                        <span>{{ suggestion.date }}</span>
                                    </div>
                                    <div class="comment-content">
                                        <p style="font-size: 19px;">{{ suggestion.main }}</p>
                                        <p style="color: #4b4a4a;">{{ suggestion.justification }}</p>
                                        <!-- Agrega más contenido si es necesario -->
                                    </div>
                                </a>
                                <ul>
                                    {% for suggestion_id, vote_info in votes_info.items %}
                                        {% if suggestion_id == suggestion.id %}
                                            <li>Votos a favor: {{ vote_info.favor_count }}</li>
                                            <li>Votos en contra: {{ vote_info.against_count }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endwith %}
                    {% else %}
                    <div class="comment-box" onclick="goToSuggestionPage(parseInt('{{ suggestion.page }}'), '{{ pdf.pdf_file.url }}', '{{ suggestion.section }}')">
                        <div class="comment-header">
                            <span>{{ suggestion.professional }}</span>
                            <span>{{ suggestion.date }}</span>
                        </div>
                        <div class="comment-content">
                            <p style="font-size: 19px;">{{ suggestion.main }}</p>
                            <p style="color: #4b4a4a;">{{ suggestion.justification }}</p>
                            <!-- Agrega más contenido si es necesario -->
                        </div>
                    </div>
                    {% endif %}
                {% empty %}
                    <b>No hay comentarios</b>
                {% endfor %}
            </div>

            

            <div class="pagination">
                <span class="step-links">
                    {% if page_obj.has_previous %}
                        <b><a style="color: black; text-decoration: none;" href="?page=1">&laquo; Primera</a></b>
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.previous_page_number }}">Anterior</a></b>
                    {% endif %}
        
                    <span class="current">
                        <br>
                        <b>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.</b>
                    </span>
        
                    {% if page_obj.has_next %}
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.next_page_number }}">Siguiente</a></b>
                        <b><a style="color: black; text-decoration: none;" href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a></b>
                    {% endif %}
                </span>
            </div>
        </div>
        
        
        
        {% if pdf.status == 'Aportaciones' %}
        <button class="comment-form-container" id="captureButton" type="submit">Capturar Selección</button>
        <div class="comment-form-container">
            <!-- Formulario para enviar comentarios -->
            <form method="post" action="{% url 'create_suggestion' document_id=pdf.pk %}">
                {% csrf_token %}
                <div class="comment-field">
                    <label for="main">Título del comentario:</label>
                    <input type="text" id="main" name="main" placeholder="Título del comentario" required>
                </div>
                <div class="comment-field">
                    <label for="relevance">Relevancia:</label>
                    <select id="relevance" name="relevance" required>
                        <option value="urgente">Muy importante</option>
                        <option value="importante">Importante</option>
                        <option value="poco">Poco importante</option>
                    </select>
                </div>
                <div class="comment-field">
                    <label for="justification">Cuerpo del comentario:</label>
                    <textarea id="justification" name="justification" placeholder="Cuerpo del comentario" required></textarea>
                </div>

                <div class="comment-field">
                    <label for="section">Sección:</label>
                    <textarea id="section" name="section" placeholder="Sección" required></textarea>
                </div>
            
                <div class="comment-field">
                    <label for="page">Pagina:</label><br>
                    <input type="number" id="page" name="page" required>
                </div>

                <button type="submit">Enviar comentario</button>
            </form>
        </div>
        {% endif %}
        
    </div>
    {% if request.user.is_staff or request.user in pdf.professionals.all %}
    <a href="{% url 'view_pdf_chat' pk=pdf.pk %}">
        <button type="button" class="btn btn-secondary" href="{% url 'view_pdf_chat' pk=pdf.pk %}" >
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125m.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2"/>
            </svg>
        </button>
    </a>
    {% endif %}

</div>

<script>

function verSeleccion() {
        var page = document.getElementById('page').value;
        var pdfUrl = '{{ pdf.pdf_file.url }}';
        var section = document.getElementById('section').value;
        goToSuggestionPage(page, pdfUrl, section);
}

function limpiarSeleccion() {
        var page = document.getElementById('page').value;
        var pdfUrl = '{{ pdf.pdf_file.url }}';
        var section = document.getElementById('section').value = "";
        goToSuggestionPage(page, pdfUrl, section);
}

function toggleFullScreen() {
        var iframe = document.getElementById('pdfViewer');
        if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
        } else if (iframe.mozRequestFullScreen) { /* Firefox */
            iframe.mozRequestFullScreen();
        } else if (iframe.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
            iframe.webkitRequestFullscreen();
        } else if (iframe.msRequestFullscreen) { /* IE/Edge */
            iframe.msRequestFullscreen();
        }
    }


    // Mantén un objeto para registrar el resaltado de texto
var highlightedText = {};

function goToSuggestionPage(pageNumber, pdfUrl, section) {

    var iframe = document.getElementById('pdfViewer');
    
    iframe.src = "/static/pdfjs/web/viewer.html?file=" + pdfUrl;
    iframe.onload = function() {
        // Verifica si se encuentra el iframe
        var documentIframe = iframe.contentDocument || iframe.contentWindow.document;
        if (documentIframe) {
            // Construye la nueva URL de la página del PDF
            var pdfUrl = iframe.src;
            var newUrl = pdfUrl + '#page=' + pageNumber;
            // Establece la nueva URL del iframe
            iframe.src = newUrl;
            iframe.document = newUrl;

            if (section !== ""){
                // Espera un breve período de tiempo antes de aplicar el resaltado
            setTimeout(function() {
                // Buscar el elemento de la página actual
                var pageElement = documentIframe.querySelector('.page[data-page-number="' + pageNumber + '"]');
                if (pageElement) {
                    // Obtener todos los elementos de texto dentro de la página
                    var textElements = pageElement.querySelectorAll('.textLayer');
                    let primeraPalabraEncontrada = false
                    let ultimaPalabraEncontrada = false
                    var sectionWords = section.trim().split(/\s+/) // Divide la sección en palabras

                    // Recorrer todos los elementos de texto para buscar el texto deseado
                    textElements.forEach(function(textLayer) {
                        var children = textLayer.children;

                        // Iterar sobre cada hijo y verificar si contiene el texto de la sección
                        for (var i = 0; i < children.length; i++) {
                            var child = children[i];
                            var text = child.textContent || child.innerText;
                            
                            var sectionText = text.trim().split(/\s+/)
                        
                            for (var e = 0; e<sectionText.length; e++){
                                var cleanedText = sectionText[e].trim().replace(/[^\w\d]+$/, '') //Elimina cualquier caracter no alfabetico o numerico al final
                                if (cleanedText !== '' && cleanedText === sectionWords[0].trim().replace(/[^\w\d]+$/, '')){
                                    primeraPalabraEncontrada = true
                                }

                                // Comparar el texto del hijo con la sección
                                if (cleanedText !== '' && section.trim().includes(cleanedText) && primeraPalabraEncontrada === true) {
                                    // Resaltar el texto
                                    child.style.backgroundColor = 'yellow';

                                    // Registra el texto resaltado
                                    highlightedText[pageNumber + '-' + i] = true;

                                    //Verificar si el texto coincide con la última palabra del sectionWord
                                    
                                    if (cleanedText === sectionWords[sectionWords.length - 1].trim().replace(/[^\w\d]+$/, '')){
                                        ultimaPalabraEncontrada = true
                                        break; //Detiene el bucle si lo encuentra
                                    } 
                                }
                            }

                            if (ultimaPalabraEncontrada === true){
                                break;
                            }
                        
                        }
                    });
                } else {
                    console.error('No se encontró la página ' + pageNumber + ' en el visor de PDF.');
                }
            }, 1000); // Esperar 1 segundo antes de aplicar el resaltado
        } else {
            console.error('No se pudo cargar el documento PDF en el visor.');
        }
    };

    // Evento que se dispara cuando el PDF se carga completamente
    iframe.addEventListener('load', function() {
        // Verifica si hay texto resaltado registrado
        Object.keys(highlightedText).forEach(function(key) {
            var [pageNum, childNum] = key.split('-');
            var pageElement = document.getElementById('pageContainer' + pageNum);
            if (pageElement) {
                var textLayer = pageElement.querySelector('.textLayer');
                if (textLayer) {
                    var child = textLayer.children[childNum];
                    if (child) {
                        // Resalta el texto
                        child.style.backgroundColor = 'yellow';
                        child.style.color = 'black';
                    }
                }
            }
        });
    });
} 

            
}


    function captureSelection() {
    var iframe = document.getElementById('pdfViewer');
    var selectedText = '';
    var currentPage = 0;

    // Verifica si se encuentra el iframe
    if (iframe) {
        var documentIframe = iframe.contentDocument || iframe.contentWindow.document;
        
        // Captura el texto seleccionado
        selectedText = documentIframe.getSelection().toString().replace(/(\r\n|\n|\r)/gm, " ").trim();
        
        console.log(selectedText)
        // Obtiene el número de página actual
        currentPage = documentIframe.getElementById("pageNumber").value;
        console.log(currentPage)
        // Actualiza los campos del formulario con la selección y la página
        document.getElementById('section').value = selectedText;
        document.getElementById('page').value = currentPage;

        console.log(document.getElementById('section').value)
        // Muestra una alerta
        alert('Se ha capturado el texto seleccionado del PDF. Verifica los campos sección y página del formulario.');

        // Muestra el botón "Ver Selección"
        document.getElementById('verSeleccionButton').style.display = 'inline';
        document.getElementById('limpiarSeleccionButton').style.display = 'inline';
    }
    }

    // Evento para capturar la selección al hacer clic en un botón o realizar alguna acción específica
    document.getElementById('captureButton').addEventListener('click', function() {
        captureSelection();
    });

    // Obtener la fecha de inicio del contador desde el backend (en formato de cadena)
    var suggestionStartDateStr = "{{ pdf.suggestion_start_date }}";

    // Expresión regular para extraer los componentes de la fecha y hora
    var regex = /(\d{1,2}) de ([a-z]+) de (\d{4}) a las (\d{2}):(\d{2})/i;
    var matches = suggestionStartDateStr.match(regex);

    // Verificar si hay coincidencias
    if (matches && matches.length === 6) {
        var day = parseInt(matches[1]);
        var month = matches[2];
        var year = parseInt(matches[3]);
        var hour = parseInt(matches[4]);
        var minute = parseInt(matches[5]);

        // Convertir el nombre del mes a su número correspondiente
        var months = {
            "enero": 0,
            "febrero": 1,
            "marzo": 2,
            "abril": 3,
            "mayo": 4,
            "junio": 5,
            "julio": 6,
            "agosto": 7,
            "septiembre": 8,
            "octubre": 9,
            "noviembre": 10,
            "diciembre": 11
        };
        var monthNumber = months[month.toLowerCase()];

        // Construir un objeto Date con los componentes extraídos
        var startDate = new Date(year, monthNumber, day, hour, minute);

        // Función para actualizar el contador regresivo
        function actualizarContador() {
            // Obtener la fecha y hora actual
            var now = new Date();

            // Calcular la diferencia en milisegundos entre la fecha de inicio y la fecha actual
            var difference = startDate.getTime() - now.getTime();

            // Calcular los días, horas, minutos y segundos restantes
            var days = Math.floor(difference / (1000 * 60 * 60 * 24));
            var hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((difference % (1000 * 60)) / 1000);

            // Mostrar el contador en el elemento HTML con id "contador"
            document.getElementById("contador").innerHTML = "Tiempo restante para empezar las aportaciones: " + days + " días " + hours + " horas " + minutes + " minutos " + seconds + " segundos ";

            // Actualizar el contador cada segundo
            setTimeout(actualizarContador, 1000);
        }

        // Iniciar el contador cuando la página se carga completamente
        window.onload = function() {
            actualizarContador();
        };
    } else {
        // Si la cadena no tiene el formato esperado, mostrar un mensaje de error
        document.getElementById("contador").innerHTML = "Error: Formato de fecha incorrecto.";
    }

</script>




{% endblock %}